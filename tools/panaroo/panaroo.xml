<tool id="panaroo" name="Panaroo" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="23.02" license="MIT">
    <description>Generate core gene alignments from GFF3 files in a pangenome analysis.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <edam_topics>
        <edam_topic>topic_3945</edam_topic> <!-- "Molecular evolution " -->
        <edam_topic>topic_0084</edam_topic> <!-- "Phylogeny" -->
        <edam_topic>topic_3053</edam_topic> <!-- "Genetics" -->
    </edam_topics>
    <edam_operations>
        <edam_operation>operation_3432</edam_operation> <!-- "Gene clustering" -->
        <edam_operation>operation_2424</edam_operation> <!-- "Genome comparison" -->
        <edam_operation>operation_0337</edam_operation> <!-- "Visualisation" -->
    </edam_operations>
    <xrefs>
        <xref type="bio.tools">Panaroo</xref>
    </xrefs>
    
    <command detect_errors="exit_code"><![CDATA[
        panaroo
            -i '$input1'
            -o out
            --clean-mode '$mode'
            '$remove_invalid_genes'
            --threshold '$threshold'
            --family_threshold '$family_identity'
            '$len_dif_percent'
            '$merge_paralogs'
            '$search_radius'
            '$refind_prop_match'
            '$refind_mode'
            '$alignment' 
            '$aligner'
            
        #for $f in $input1
            '$f'
        #end for
    ]]></command>
    
    <inputs>
        <param type="data" name="input1" format="gff,gff3" multiple="true" label="Select gff inputs to Panaroo" help="Select the files you wish to analyze with Panaroo, must be in gff3 format."/>
        <!--MODES-->
        <param name="mode" type="select" label="filtering mode" help="Change a number of defaults to either favour strict, moderate or sensitive filtering">
            <option value="strict" selected="True">Strict</option>
            <option value="moderate">Moderate</option>
            <option value="sensitive ">Sensitive</option>
        </param>
        <param name="remove_invalid_genes" type="boolean" truevalue="--remove-invalid-genes" falsevalue="" label="Remove Invalid Genes" help="Removes annotations that do not conform to the expected Prokka format. Disabled by default."/>
        <!--Gene Alignment-->
        <param name="alignment" type="select" label="Alignment" help="Run MSA either for the core genome or for every gene cluster.">
            <option value="core">Core genome alignment</option>
            <option value="pan">Pan-genome alignment</option>
            <option value="none" selected="True">None</option>
        </param>
        <param name="aligner" type="select" label="Alignment method" help="Choose an aligner from either PRANK, Clustal or the default, MAFFT.">
            <option value="mafft" selected="True">MAFFT</option>
            <option value="clustal">Clustal</option>
            <option value="prank">PRANK</option>
            <option value="none">None</option>
        </param>
        <!--Cluster Thresholds-->
        <param name="threshold" type="float" value="0.98" label="Initial Clustering Threshold" help="Set the threshold for gene clustering. Default is 0.98."/>
        <param name="len_dif_percent" type="float" value="0.98" label="Length Difference Percent" help="Set the length difference percent for initial gene clustering. Default is 0.98."/>
        <param name="family_identity" type="float" value="0.7" label="Family Sequence Identity Level" help="Set the level at which Panaroo collapses genes into putative families. Default is 0.7."/>
        <param name="merge_paralogs" type="boolean" truevalue="--merge_paralogs" falsevalue="" label="Merge Paralogs" help="Merging paralogs can be enabled. Disabled by default."/>
        <!--Refinding Genes-->
        <param name="search_radius" type="integer" value="5000" label="Refinding Search Radius" help="Set radius for the search in nucleotides for refinding genes. Default is 5000."/>
        <param name="refind_prop_match" type="float" value="0.5" label="Refinding Proportion Match" help="Set the proportion of the missing gene to consider as a match for refinding. Default is 0.5."/>
        <param name="refind_mode" type="select" label="Refind Mode" help="Set the stringency mode at which to re-find genes.">
            <option value="default" selected="True">Default</option>
            <option value="strict">Strict</option>
            <option value="off ">Off</option>
        </param>
        <!--GRAPH CORRECTION -->
    </inputs>

    <outputs>
        <data format="csv" name="gene_p_a" label="${tool.name} on ${on_string} Gene Presence Absence" from_work_dir="out/gene_presence_absence.csv"/>
        <data format="fasta" name="core_gene_aln" label="${tool.name} on ${on_string} Core Gene Alignment" from_work_dir="out/core_gene_alignment.aln"/>
    </outputs>

    <tests>
        <!-- Hint: You can use [ctrl+alt+t] after defining the inputs/outputs to auto-scaffold some basic test cases. -->
        <test expect_num_outputs="2">
            <param name="input1" value="ex1.gff" ftype="gff3"/>
            <param name="mode" value="strict"/>
            <param name="remove_invalid_genes" value="false"/>
            <param name="alignment" value="core"/>
            <param name="aligner" value="mafft"/>
            <output name="gene_p_a" file="out/gene_p_a.csv" ftype="csv"/>
            <output name="core_gene_aln" file="out/core_gene_alignment.aln" ftype="fasta"/>
        </test>
        <test expect_num_outputs="2">
            <param name="input1" value="ex1.gff" ftype="gff3"/>
            <param name="mode" value="strict"/>
            <output name="gene_p_a" file="out/gene_p_a.csv" ftype="csv"/>
            <output name="core_gene_aln" file="out/core_gene_alignment.aln" ftype="fasta"/>
        </test>
        <test expect_num_outputs="2">
            <param name="input1" value="ex1.gff" ftype="gff3"/>
            <param name="remove_invalid_genes" value="false"/>
            <output name="gene_p_a" file="out/gene_p_a.csv" ftype="csv"/>
            <output name="core_gene_aln" file="out/core_gene_alignment.aln" ftype="fasta"/>
        </test>
    </tests>
    <help><![CDATA[

**Panaroo**
Galaxy does not support gml files.

Found in outputs:
<data format="gml" name="final_graph" label="${tool.name} on ${on_string} Final Graph" from_work_dir="out/final_graph.gml"/>
Found in tests:
<output name="final_graph" file="out/final_graph.gml" ftype="gml"/>

Panaroo is a pangenome analysis tool specifically designed to analyze bacterial genomes. Its main goal is to create accurate pangenomes by identifying and grouping genes that are shared or unique across multiple genomes within a species. Panaroo is built to overcome some of the challenges in pangenome analysis, especially issues with paralogs (genes that arise by duplication within the same genome) and annotation inconsistencies between different genome assemblies.

    ]]></help>
    <citations>
        <citation type="doi">10.1186/s13059-020-02090-4</citation>
    </citations>
</tool>